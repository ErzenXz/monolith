<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monolith - Media Compression API</title>
  <meta name="description" content="High-performance media compression API dashboard" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>%F0%9F%97%9C</text></svg>" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { 50:'#f0f9ff',100:'#e0f2fe',200:'#bae6fd',300:'#7dd3fc',400:'#38bdf8',500:'#0ea5e9',600:'#0284c7',700:'#0369a1',800:'#075985',900:'#0c4a6e' }
          }
        }
      }
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    .fade-in { animation: fadeIn .3s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse-ring { 0% { transform:scale(.8); opacity:1; } 100% { transform:scale(1.4); opacity:0; } }
    .status-pulse { position:relative; }
    .status-pulse::before { content:''; position:absolute; inset:-3px; border-radius:50%; animation:pulse-ring 1.5s ease-out infinite; }
    .status-pulse.healthy::before { background:#22c55e; }
    .status-pulse.unhealthy::before { background:#ef4444; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    .glass { background: rgba(17,24,39,0.8); backdrop-filter: blur(12px); }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none"></div>

  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md fade-in">
      <!-- Logo -->
      <div class="text-center mb-8">
        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center shadow-xl shadow-brand-500/20">
          <svg class="w-9 h-9 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        </div>
        <h1 class="text-2xl font-bold">Monolith</h1>
        <p class="text-gray-500 text-sm mt-1">Media Compression API Dashboard</p>
      </div>

      <!-- Login Card -->
      <div class="bg-gray-900 rounded-2xl border border-gray-800 p-6 shadow-2xl">
        <h2 class="text-sm font-medium text-gray-400 mb-4">Authentication Required</h2>
        <div class="space-y-4">
          <div>
            <label for="api-key" class="block text-xs text-gray-500 mb-2">API Key</label>
            <input id="api-key" type="password" placeholder="Enter your API key" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent placeholder-gray-600" />
          </div>
          <div>
            <label for="api-url" class="block text-xs text-gray-500 mb-2">API Base URL</label>
            <input id="api-url" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent placeholder-gray-600" />
          </div>
          <button onclick="login()" id="login-btn" class="w-full py-3 bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 rounded-xl font-medium text-sm transition-all shadow-lg shadow-brand-500/25">
            Access Dashboard
          </button>
        </div>

        <!-- API Info -->
        <div class="mt-6 pt-6 border-t border-gray-800">
          <p class="text-[10px] text-gray-600 text-center">Protected by API key authentication</p>
          <div class="mt-3 grid grid-cols-3 gap-2 text-center">
            <div class="bg-gray-800/50 rounded-lg p-2">
              <p class="text-[10px] text-gray-500">Storage</p>
              <p class="text-xs text-gray-300">Vercel Blob</p>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-2">
              <p class="text-[10px] text-gray-500">Queue</p>
              <p class="text-xs text-gray-300">Upstash QStash</p>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-2">
              <p class="text-[10px] text-gray-500">Rate Limit</p>
              <p class="text-xs text-gray-300">Vercel KV</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD (hidden until login) -->
  <div id="dashboard" class="hidden">
    <!-- Header -->
    <header class="border-b border-gray-800 bg-gray-950/80 backdrop-blur-sm sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          </div>
          <div>
            <h1 class="text-sm font-bold leading-tight">Monolith</h1>
            <p class="text-[9px] text-gray-500 leading-none">v2.0.0</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="health-status" class="flex items-center gap-2 text-xs text-gray-400">
            <span class="w-2 h-2 rounded-full bg-gray-600"></span>
            <span>Checking...</span>
          </div>
          <button onclick="refreshAll()" class="text-gray-500 hover:text-gray-300 transition-colors" title="Refresh">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
          </button>
          <button onclick="logout()" class="text-xs text-gray-600 hover:text-red-400 transition-colors">Logout</button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-6">

      <!-- Service Status Cards -->
      <section>
        <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Service Health</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="service-status-grid">
          <!-- Populated by JS -->
        </div>
      </section>

      <!-- Stats Row -->
      <section>
        <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Overview</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <p class="text-[10px] text-gray-500 uppercase tracking-wider">Total Jobs</p>
            <p id="stat-total" class="text-2xl font-bold mt-1">--</p>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <p class="text-[10px] text-gray-500 uppercase tracking-wider">Active</p>
            <p id="stat-active" class="text-2xl font-bold mt-1 text-blue-400">--</p>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <p class="text-[10px] text-gray-500 uppercase tracking-wider">Completed</p>
            <p id="stat-completed" class="text-2xl font-bold mt-1 text-green-400">--</p>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <p class="text-[10px] text-gray-500 uppercase tracking-wider">Failed</p>
            <p id="stat-failed" class="text-2xl font-bold mt-1 text-red-400">--</p>
          </div>
        </div>
      </section>

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Compress Panel (2 cols) -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Quick Compress -->
          <section class="bg-gray-900 rounded-xl border border-gray-800 p-5">
            <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Test Compression</h2>
            <div id="drop-zone" class="border-2 border-dashed border-gray-700 rounded-xl p-8 text-center cursor-pointer hover:border-gray-600 transition-colors">
              <svg class="w-8 h-8 mx-auto mb-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
              <p class="text-gray-400 text-sm mb-1">Drop file or <span class="text-brand-400 underline">browse</span></p>
              <p class="text-gray-600 text-[10px]">Images, videos, audio up to 500MB</p>
              <input id="file-input" type="file" class="hidden" accept="image/*,video/*,audio/*" />
            </div>
            <div id="file-preview" class="hidden mt-3 bg-gray-800 rounded-lg p-3">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div id="file-icon" class="w-9 h-9 rounded-lg bg-gray-700 flex items-center justify-center text-base"></div>
                  <div>
                    <p id="file-name" class="text-sm font-medium"></p>
                    <p id="file-meta" class="text-[10px] text-gray-500"></p>
                  </div>
                </div>
                <button onclick="clearFile()" class="text-gray-500 hover:text-gray-300 text-xs">Remove</button>
              </div>
            </div>
            <div id="options-panel" class="hidden mt-3 space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-[10px] text-gray-500 mb-1">Output Format</label>
                  <select id="output-format" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500"></select>
                </div>
                <div>
                  <label class="block text-[10px] text-gray-500 mb-1">Quality/Bitrate</label>
                  <input id="qualities" type="text" placeholder="Default" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 placeholder-gray-600" />
                </div>
              </div>
              <button onclick="startCompression()" id="compress-btn" class="w-full py-2.5 bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 rounded-lg font-medium text-sm transition-all">Compress Media</button>
            </div>
          </section>

          <!-- Recent Jobs -->
          <section class="bg-gray-900 rounded-xl border border-gray-800 p-5">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider">Recent Jobs</h2>
              <div class="flex border-b border-gray-800 text-xs">
                <button onclick="setJobFilter('all')" data-filter="all" class="pb-1 px-2 border-b-2 tab-active transition-colors">All</button>
                <button onclick="setJobFilter('active')" data-filter="active" class="pb-1 px-2 border-b-2 tab-inactive transition-colors">Active</button>
                <button onclick="setJobFilter('completed')" data-filter="completed" class="pb-1 px-2 border-b-2 tab-inactive transition-colors">Done</button>
                <button onclick="setJobFilter('failed')" data-filter="failed" class="pb-1 px-2 border-b-2 tab-inactive transition-colors">Failed</button>
              </div>
            </div>
            <div id="jobs-list" class="space-y-2">
              <p id="no-jobs" class="text-xs text-gray-600 text-center py-6">Loading jobs...</p>
            </div>
          </section>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- API Endpoints -->
          <section class="bg-gray-900 rounded-xl border border-gray-800 p-5">
            <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">API Endpoints</h2>
            <div class="space-y-2 text-[11px] font-mono">
              <div class="flex gap-2 items-center"><span class="text-green-400 w-10 shrink-0">POST</span><span class="text-gray-400 truncate">/api/compress/image</span></div>
              <div class="flex gap-2 items-center"><span class="text-green-400 w-10 shrink-0">POST</span><span class="text-gray-400 truncate">/api/compress/video</span></div>
              <div class="flex gap-2 items-center"><span class="text-green-400 w-10 shrink-0">POST</span><span class="text-gray-400 truncate">/api/compress/audio</span></div>
              <div class="flex gap-2 items-center"><span class="text-blue-400 w-10 shrink-0">GET</span><span class="text-gray-400 truncate">/api/jobs</span></div>
              <div class="flex gap-2 items-center"><span class="text-blue-400 w-10 shrink-0">GET</span><span class="text-gray-400 truncate">/api/jobs/status/:id</span></div>
              <div class="flex gap-2 items-center"><span class="text-red-400 w-10 shrink-0">DEL</span><span class="text-gray-400 truncate">/api/jobs/delete/:id</span></div>
            </div>
          </section>

          <!-- Supported Formats -->
          <section class="bg-gray-900 rounded-xl border border-gray-800 p-5">
            <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Supported Formats</h2>
            <div class="space-y-3">
              <div>
                <p class="text-[10px] text-gray-500 mb-1.5">Images</p>
                <div class="flex flex-wrap gap-1">
                  <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">JPEG</span>
                  <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">PNG</span>
                  <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">WebP</span>
                  <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">AVIF</span>
                  <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">GIF</span>
                </div>
              </div>
              <div>
                <p class="text-[10px] text-gray-500 mb-1.5">Videos</p>
                <div class="flex flex-wrap gap-1">
                  <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-0.5 rounded-full">MP4</span>
                  <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-0.5 rounded-full">WebM</span>
                  <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-0.5 rounded-full">MOV</span>
                </div>
              </div>
              <div>
                <p class="text-[10px] text-gray-500 mb-1.5">Audio</p>
                <div class="flex flex-wrap gap-1">
                  <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">MP3</span>
                  <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">AAC</span>
                  <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">Opus</span>
                  <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">WAV</span>
                </div>
              </div>
            </div>
          </section>

          <!-- Job Lookup -->
          <section class="bg-gray-900 rounded-xl border border-gray-800 p-5">
            <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Job Lookup</h2>
            <div class="flex gap-2">
              <input id="lookup-id" type="text" placeholder="Job ID..." class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xs font-mono focus:outline-none focus:ring-2 focus:ring-brand-500 placeholder-gray-600" />
              <button onclick="lookupJob()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs font-medium transition-colors">Go</button>
            </div>
            <div id="lookup-result" class="hidden mt-3"></div>
          </section>
        </div>
      </div>

    </main>

    <footer class="border-t border-gray-800 mt-8 py-4 text-center text-[10px] text-gray-600">
      Monolith &mdash; Media Compression API &middot; <a href="https://github.com/ErzenXz/monolith" class="text-gray-500 hover:text-gray-400">GitHub</a>
    </footer>
  </div>

<script>
// ====== STATE ======
let apiKey = null;
let baseUrl = window.location.origin;
let selectedFile = null;
let jobs = [];
let jobFilter = 'all';
let pollingIntervals = {};
let healthData = null;

// ====== DOM ======
const apiKeyInput = document.getElementById('api-key');
const apiUrlInput = document.getElementById('api-url');

// ====== HELPERS ======
function getBaseUrl() { return baseUrl.replace(/\/$/, ''); }
function formatBytes(b) {
  if (!b || b === 0) return '0 B';
  const k = 1024, s = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(b) / Math.log(k));
  return (b / Math.pow(k, i)).toFixed(1) + ' ' + s[i];
}
function getMediaType(file) {
  if (file.type.startsWith('image/')) return 'image';
  if (file.type.startsWith('video/')) return 'video';
  if (file.type.startsWith('audio/')) return 'audio';
  return 'unknown';
}
function getTypeIcon(t) {
  return {
    image:'<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',
    video:'<svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>',
    audio:'<svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>'
  }[t] || '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>';
}
function getStatusColor(s) {
  return {queued:'bg-yellow-500/15 text-yellow-400',processing:'bg-blue-500/15 text-blue-400',completed:'bg-green-500/15 text-green-400',failed:'bg-red-500/15 text-red-400'}[s]||'bg-gray-500/15 text-gray-400';
}
function getStatusDot(s) {
  return {queued:'bg-yellow-400',processing:'bg-blue-400',completed:'bg-green-400',failed:'bg-red-400'}[s]||'bg-gray-400';
}
function timeAgo(d) {
  const s=Math.floor((Date.now()-new Date(d))/1000);
  if(s<60) return s+'s ago';
  if(s<3600) return Math.floor(s/60)+'m ago';
  if(s<86400) return Math.floor(s/3600)+'h ago';
  return Math.floor(s/86400)+'d ago';
}
function esc(s) {
  const d=document.createElement('div');
  d.textContent=s;
  return d.innerHTML;
}

// ====== TOAST ======
function showToast(message, type='info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  const colors = {success:'bg-green-900/95 border-green-700 text-green-200',error:'bg-red-900/95 border-red-700 text-red-200',info:'bg-gray-800/95 border-gray-600 text-gray-200'};
  toast.className = `${colors[type]||colors.info} border rounded-lg px-4 py-2.5 text-xs shadow-xl fade-in backdrop-blur-sm pointer-events-auto`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity .3s'; setTimeout(()=>toast.remove(),300); }, 4000);
}

// ====== API HELPERS ======
async function apiRequest(endpoint, options = {}) {
  const url = getBaseUrl() + endpoint;
  const headers = {
    'X-API-Key': apiKey,
    ...options.headers
  };
  const res = await fetch(url, { ...options, headers });

  const ct = res.headers.get('content-type') || '';
  const text = await res.text();
  if (ct.includes('application/json')) {
    try { return { ok: res.ok, data: JSON.parse(text) }; }
    catch { /* fall through */ }
  }
  if (!res.ok) throw new Error(`Server error ${res.status}: ${text.slice(0, 120)}`);
  try { return { ok: true, data: JSON.parse(text) }; }
  catch { throw new Error(`Unexpected response: ${text.slice(0, 120)}`); }
}

// ====== LOGIN ======
apiUrlInput.value = window.location.origin;
const savedKey = localStorage.getItem('monolith_api_key');
if (savedKey) {
  apiKeyInput.value = savedKey;
  const savedUrl = localStorage.getItem('monolith_api_url');
  if (savedUrl) apiUrlInput.value = savedUrl;
}
apiUrlInput.addEventListener('change', () => localStorage.setItem('monolith_api_url', apiUrlInput.value));

async function login() {
  const key = apiKeyInput.value.trim();
  const url = apiUrlInput.value.trim();
  if (!key) { showToast('Please enter an API key', 'error'); return; }

  const btn = document.getElementById('login-btn');
  btn.innerHTML = '<svg class="w-4 h-4 inline spinner mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Verifying...';
  btn.disabled = true;

  try {
    baseUrl = url;
    // Verify API key by checking health
    const { ok, data } = await apiRequest('/api/health');
    if (!ok) throw new Error('Authentication failed');

    apiKey = key;
    localStorage.setItem('monolith_api_key', key);
    localStorage.setItem('monolith_api_url', url);
    healthData = data;

    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    showToast('Welcome to Monolith', 'success');

    // Initialize dashboard
    updateServiceStatus();
    updateStats();
    loadJobs();
  } catch (e) {
    showToast('Invalid API key or connection failed', 'error');
  } finally {
    btn.innerHTML = 'Access Dashboard';
    btn.disabled = false;
  }
}

function logout() {
  apiKey = null;
  localStorage.removeItem('monolith_api_key');
  Object.keys(pollingIntervals).forEach(id => clearInterval(pollingIntervals[id]));
  pollingIntervals = {};
  jobs = [];
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
  apiKeyInput.value = '';
}

// ====== SERVICE STATUS ======
async function updateServiceStatus() {
  try {
    const { data } = await apiRequest('/api/health');
    healthData = data;
    const services = data.services || {};
    const config = data.config || {};

    document.getElementById('service-status-grid').innerHTML = `
      ${serviceCard('Queue', services.queue, 'QStash')}
      ${serviceCard('Storage', services.storage, 'Vercel Blob')}
      ${serviceCard('Rate Limit', services.rateLimit, 'Vercel KV')}
      ${serviceCard('API Keys', config.apiKeysConfigured, 'Configured')}
    `;

    const indicator = document.getElementById('health-status');
    const isHealthy = data.status === 'healthy';
    indicator.innerHTML = `
      <span class="w-2 h-2 rounded-full ${isHealthy?'bg-green-400 status-pulse healthy':'bg-red-400 status-pulse unhealthy'}"></span>
      <span>${isHealthy?'Healthy':'Unhealthy'}</span>
    `;
  } catch (e) {
    document.getElementById('health-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span><span>Offline</span>';
  }
}

function serviceCard(name, ok, subtitle) {
  return `<div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
    <div class="flex items-center gap-3">
      <span class="w-2 h-2 rounded-full ${ok?'bg-green-400':'bg-red-400'}"></span>
      <div>
        <p class="text-[10px] text-gray-500">${name}</p>
        <p class="text-sm font-medium ${ok?'text-green-400':'text-red-400'}">${ok?'Online':'Offline'}</p>
      </div>
    </div>
    <p class="text-[10px] text-gray-600 mt-2">${subtitle}</p>
  </div>`;
}

// ====== STATS ======
async function updateStats() {
  try {
    const { data } = await apiRequest('/api/jobs?limit=1');
    const total = data.total || 0;
    const active = jobs.filter(j => j.status === 'queued' || j.status === 'processing').length;
    const completed = jobs.filter(j => j.status === 'completed').length;
    const failed = jobs.filter(j => j.status === 'failed').length;

    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-active').textContent = active;
    document.getElementById('stat-completed').textContent = completed;
    document.getElementById('stat-failed').textContent = failed;
  } catch (e) { /* ignore */ }
}

// ====== JOBS ======
async function loadJobs() {
  try {
    const { data } = await apiRequest('/api/jobs?limit=50');
    jobs = data.jobs || [];
    renderJobs();
  } catch (e) {
    document.getElementById('no-jobs').textContent = 'Failed to load jobs';
  }
}

function setJobFilter(f) {
  jobFilter = f;
  document.querySelectorAll('[data-filter]').forEach(btn => {
    btn.classList.toggle('tab-active', btn.dataset.filter === f);
    btn.classList.toggle('tab-inactive', btn.dataset.filter !== f);
  });
  renderJobs();
}

function renderJobs() {
  const container = document.getElementById('jobs-list');
  const noJobs = document.getElementById('no-jobs');
  const filtered = jobs.filter(j => {
    if (jobFilter === 'all') return true;
    if (jobFilter === 'active') return j.status === 'queued' || j.status === 'processing';
    return j.status === jobFilter;
  });

  container.querySelectorAll('.job-card').forEach(el => el.remove());

  if (filtered.length === 0) {
    noJobs.classList.remove('hidden');
    noJobs.textContent = jobFilter==='all'?'No jobs yet':'No '+jobFilter+' jobs';
    return;
  }

  noJobs.classList.add('hidden');
  filtered.forEach(job => {
    const card = document.createElement('div');
    card.className = 'job-card bg-gray-800/50 rounded-lg p-3 fade-in';
    const type = job.type || 'unknown';
    const elapsed = job.completedAt ?
      ((new Date(job.completedAt)-new Date(job.createdAt))/1000).toFixed(1)+'s' :
      job.estimatedTime || '...';

    card.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          ${getTypeIcon(type)}
          <div>
            <p class="text-xs font-medium">${esc(job.fileName || 'Unknown')}</p>
            <p class="text-[10px] text-gray-500">${formatBytes(job.fileSize || 0)} · ${elapsed}</p>
          </div>
        </div>
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${getStatusColor(job.status)}">
          <span class="w-1 h-1 rounded-full ${getStatusDot(job.status)}"></span>${job.status}
        </span>
      </div>
      ${job.progress !== undefined ? `<div class="w-full bg-gray-700 rounded-full h-1"><div class="bg-brand-500 h-1 rounded-full transition-all" style="width:${job.progress}%"></div></div>` : ''}
      ${job.results?.compressionRatio ? `<p class="text-[10px] text-green-400 mt-1">Saved ${job.results.compressionRatio}</p>` : ''}
      <p class="text-[9px] text-gray-600 mt-1 font-mono select-all">${job.id}</p>
    `;
    container.appendChild(card);

    // Start polling for active jobs
    if (job.status === 'queued' || job.status === 'processing') {
      startPolling(job.id);
    }
  });
}

function startPolling(jobId) {
  if (pollingIntervals[jobId]) return;
  pollingIntervals[jobId] = setInterval(async () => {
    try {
      const { data } = await apiRequest(`/api/jobs/status/${jobId}`);
      if (!data.success) return;

      const idx = jobs.findIndex(j => j.id === jobId);
      if (idx === -1) { clearInterval(pollingIntervals[jobId]); delete pollingIntervals[jobId]; return; }

      jobs[idx] = { ...jobs[idx], ...data };
      renderJobs();
      updateStats();

      if (data.status === 'completed' || data.status === 'failed') {
        clearInterval(pollingIntervals[jobId]);
        delete pollingIntervals[jobId];
      }
    } catch (e) { /* retry */ }
  }, 3000);
}

async function deleteJob(jobId) {
  if (!confirm('Delete this job?')) return;
  try {
    const { data } = await apiRequest(`/api/jobs/delete/${jobId}`, { method: 'DELETE' });
    if (data.success) {
      jobs = jobs.filter(j => j.id !== jobId);
      renderJobs();
      updateStats();
      showToast('Job deleted', 'success');
    }
  } catch (e) { showToast('Delete failed', 'error'); }
}

async function lookupJob() {
  const id = document.getElementById('lookup-id').value.trim();
  const rd = document.getElementById('lookup-result');
  if (!id) { showToast('Enter a job ID','error'); return; }
  rd.classList.remove('hidden');
  rd.innerHTML = '<p class="text-xs text-gray-500">Looking up...</p>';
  try {
    const { data } = await apiRequest(`/api/jobs/status/${id}`);
    if (!data.success) {
      rd.innerHTML = `<div class="bg-red-500/10 border border-red-800 rounded-lg p-3 text-xs text-red-400">Job not found</div>`;
      return;
    }
    rd.innerHTML = `<div class="bg-gray-800/50 rounded-lg p-3 space-y-2">
      <div class="flex justify-between items-center"><span class="text-xs font-medium font-mono">${data.jobId}</span><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${getStatusColor(data.status)}"><span class="w-1.5 h-1.5 rounded-full ${getStatusDot(data.status)}"></span>${data.status}</span></div>
      <div class="grid grid-cols-2 gap-1 text-[11px] text-gray-400"><div>Type: <span class="text-gray-200">${data.type||'N/A'}</span></div><div>Progress: <span class="text-gray-200">${data.progress??0}%</span></div></div>
      ${data.error?`<div class="text-[11px] text-red-400 bg-red-500/10 rounded px-2 py-1">${data.error}</div>`:''}
      ${data.results?`<div class="text-[11px] text-green-400">Ratio: ${data.results.compressionRatio||'N/A'}</div>`:''}
    </div>`;
  } catch (e) { rd.innerHTML = `<div class="bg-red-500/10 border border-red-800 rounded-lg p-3 text-xs text-red-400">${e.message}</div>`; }
}

// ====== FILE UPLOAD ======
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-brand-500'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-brand-500'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('border-brand-500');
  if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => { if(e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  selectedFile = file;
  const type = getMediaType(file);
  document.getElementById('file-icon').innerHTML = getTypeIcon(type);
  document.getElementById('file-name').textContent = file.name;
  document.getElementById('file-meta').textContent = `${formatBytes(file.size)} · ${file.type}`;
  document.getElementById('file-preview').classList.remove('hidden');
  document.getElementById('options-panel').classList.remove('hidden');

  const fmt = document.getElementById('output-format');
  if (type==='image') {
    fmt.innerHTML='<option value="webp">WebP</option><option value="jpeg">JPEG</option><option value="png">PNG</option><option value="avif">AVIF</option>';
  } else if (type==='video') {
    fmt.innerHTML='<option value="mp4">MP4</option><option value="webm">WebM</option><option value="mov">MOV</option>';
  } else if (type==='audio') {
    fmt.innerHTML='<option value="mp3">MP3</option><option value="aac">AAC</option><option value="opus">Opus</option><option value="wav">WAV</option>';
  }
}

function clearFile() {
  selectedFile=null;
  fileInput.value='';
  document.getElementById('file-preview').classList.add('hidden');
  document.getElementById('options-panel').classList.add('hidden');
}

async function startCompression() {
  if (!selectedFile) return;
  const type = getMediaType(selectedFile);
  const format = document.getElementById('output-format').value;
  const btn = document.getElementById('compress-btn');
  btn.innerHTML = '<svg class="w-4 h-4 inline spinner mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Uploading...';
  btn.disabled = true;
  try {
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('format', format);
    const qualities = document.getElementById('qualities').value.trim();
    if (qualities) formData.append(type==='audio'?'bitrates':'qualities', qualities);

    const { data, ok } = await apiRequest(`/api/compress/${type}`, {
      method: 'POST',
      body: formData
    });

    if (ok && data.success && data.jobId) {
      jobs.unshift({id:data.jobId, type, fileName:selectedFile.name, fileSize:selectedFile.size, status:'queued', progress:0, createdAt:new Date().toISOString(), estimatedTime:data.estimatedTime});
      renderJobs();
      updateStats();
      showToast('Job queued: ' + data.jobId, 'success');
      clearFile();
    } else {
      showToast(data.error || 'Unknown error', 'error');
    }
  } catch (e) {
    showToast('Request failed: ' + e.message, 'error');
  } finally {
    btn.innerHTML = 'Compress Media';
    btn.disabled = false;
  }
}

// ====== REFRESH ======
function refreshAll() {
  updateServiceStatus();
  updateStats();
  loadJobs();
}
</script>

</body>
</html>
