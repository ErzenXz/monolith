<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Media Compressor - Dashboard</title>
  <meta name="description" content="High-performance media compression API dashboard" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>%F0%9F%97%9C</text></svg>" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { 50:'#f0f9ff',100:'#e0f2fe',200:'#bae6fd',300:'#7dd3fc',400:'#38bdf8',500:'#0ea5e9',600:'#0284c7',700:'#0369a1',800:'#075985',900:'#0c4a6e' }
          }
        }
      }
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .drop-zone.dragover { border-color: #0ea5e9; background: rgba(14,165,233,0.05); }
    .fade-in { animation: fadeIn .3s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse-ring { 0% { transform:scale(.8); opacity:1; } 100% { transform:scale(1.4); opacity:0; } }
    .status-pulse { position:relative; }
    .status-pulse::before { content:''; position:absolute; inset:-3px; border-radius:50%; animation:pulse-ring 1.5s ease-out infinite; }
    .status-pulse.healthy::before { background:#22c55e; }
    .progress-bar { transition: width .5s ease; }
    .bar-segment { transition: width .6s cubic-bezier(.4,0,.2,1); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    .tab-active { border-color: #0ea5e9; color: #e0f2fe; }
    .tab-inactive { border-color: transparent; color: #6b7280; }
    .tab-inactive:hover { color: #9ca3af; border-color: #374151; }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

  <!-- Header -->
  <header class="border-b border-gray-800 bg-gray-950/80 backdrop-blur-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        </div>
        <div>
          <h1 class="text-lg font-bold leading-tight">Codec</h1>
          <p class="text-[10px] text-gray-500 leading-none">Media Compressor v2.0</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div id="health-indicator" class="flex items-center gap-2 text-sm text-gray-400">
          <span class="w-2 h-2 rounded-full bg-gray-600"></span>
          <span>Checking...</span>
        </div>
        <div id="latency-badge" class="hidden text-[10px] text-gray-500 bg-gray-800 px-2 py-0.5 rounded-full font-mono"></div>
        <button onclick="document.getElementById('shortcuts-modal').classList.toggle('hidden')" class="text-gray-500 hover:text-gray-300 transition-colors" title="Keyboard shortcuts">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"></path></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none"></div>

  <!-- Keyboard shortcuts modal -->
  <div id="shortcuts-modal" class="hidden fixed inset-0 bg-black/60 z-[200] flex items-center justify-center backdrop-blur-sm" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 max-w-sm w-full mx-4 fade-in">
      <h3 class="text-sm font-semibold mb-4">Keyboard Shortcuts</h3>
      <div class="space-y-2 text-xs">
        <div class="flex justify-between"><span class="text-gray-400">Open file picker</span><kbd class="bg-gray-800 px-2 py-0.5 rounded text-gray-300 font-mono">U</kbd></div>
        <div class="flex justify-between"><span class="text-gray-400">Test connection</span><kbd class="bg-gray-800 px-2 py-0.5 rounded text-gray-300 font-mono">T</kbd></div>
        <div class="flex justify-between"><span class="text-gray-400">Focus job lookup</span><kbd class="bg-gray-800 px-2 py-0.5 rounded text-gray-300 font-mono">L</kbd></div>
        <div class="flex justify-between"><span class="text-gray-400">Clear all jobs</span><kbd class="bg-gray-800 px-2 py-0.5 rounded text-gray-300 font-mono">Shift+X</kbd></div>
        <div class="flex justify-between"><span class="text-gray-400">Close modal</span><kbd class="bg-gray-800 px-2 py-0.5 rounded text-gray-300 font-mono">Esc</kbd></div>
      </div>
      <button onclick="this.closest('#shortcuts-modal').classList.add('hidden')" class="mt-4 w-full py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs transition-colors">Close</button>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-6">

    <!-- Config Row -->
    <section class="bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
      <div class="flex flex-col sm:flex-row gap-3">
        <div class="flex-1">
          <label for="api-key" class="block text-[10px] text-gray-500 uppercase tracking-wider mb-1">API Key</label>
          <input id="api-key" type="password" placeholder="Enter your API key" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent placeholder-gray-600" />
        </div>
        <div class="flex-1">
          <label for="api-url" class="block text-[10px] text-gray-500 uppercase tracking-wider mb-1">API Base URL</label>
          <input id="api-url" type="text" placeholder="https://your-app.vercel.app" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent placeholder-gray-600" />
        </div>
        <div class="flex items-end">
          <button onclick="checkHealth()" id="test-btn" class="px-5 py-2 bg-brand-600 hover:bg-brand-700 rounded-lg text-sm font-medium transition-colors whitespace-nowrap">Test Connection</button>
        </div>
      </div>
    </section>

    <!-- Stats Row -->
    <section class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3">
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-[10px] text-gray-500 uppercase tracking-wider">Total Jobs</p>
        <p id="stat-total" class="text-2xl font-bold mt-1">0</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-[10px] text-gray-500 uppercase tracking-wider">Completed</p>
        <p id="stat-completed" class="text-2xl font-bold mt-1 text-green-400">0</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-[10px] text-gray-500 uppercase tracking-wider">Failed</p>
        <p id="stat-failed" class="text-2xl font-bold mt-1 text-red-400">0</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-[10px] text-gray-500 uppercase tracking-wider">Bytes Processed</p>
        <p id="stat-bytes" class="text-2xl font-bold mt-1 text-brand-400">0 B</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-[10px] text-gray-500 uppercase tracking-wider">Avg Ratio</p>
        <p id="stat-ratio" class="text-2xl font-bold mt-1 text-purple-400">--</p>
      </div>
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <p class="text-[10px] text-gray-500 uppercase tracking-wider">API Latency</p>
        <p id="stat-latency" class="text-2xl font-bold mt-1 text-amber-400">--</p>
      </div>
    </section>

    <!-- Service Status + Formats (side by side) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <section id="status-section" class="hidden bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
        <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Services</h2>
        <div class="grid grid-cols-2 gap-3" id="status-grid"></div>
        <div id="health-detail" class="mt-3 text-[10px] text-gray-600 font-mono"></div>
      </section>
      <section class="bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
        <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Supported Formats</h2>
        <div class="grid grid-cols-3 gap-2">
          <div>
            <p class="text-[10px] text-gray-500 mb-1.5">Images</p>
            <div class="flex flex-wrap gap-1">
              <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">JPEG</span>
              <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">PNG</span>
              <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">WebP</span>
              <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">AVIF</span>
              <span class="bg-emerald-500/10 text-emerald-400 text-[10px] px-2 py-0.5 rounded-full">GIF</span>
            </div>
          </div>
          <div>
            <p class="text-[10px] text-gray-500 mb-1.5">Videos</p>
            <div class="flex flex-wrap gap-1">
              <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-0.5 rounded-full">MP4</span>
              <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-0.5 rounded-full">WebM</span>
              <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-0.5 rounded-full">MOV</span>
            </div>
          </div>
          <div>
            <p class="text-[10px] text-gray-500 mb-1.5">Audio</p>
            <div class="flex flex-wrap gap-1">
              <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">MP3</span>
              <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">AAC</span>
              <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">Opus</span>
              <span class="bg-violet-500/10 text-violet-400 text-[10px] px-2 py-0.5 rounded-full">WAV</span>
            </div>
          </div>
        </div>
        <!-- API endpoints quick ref -->
        <div class="mt-4 pt-3 border-t border-gray-800">
          <p class="text-[10px] text-gray-500 mb-2">API Endpoints</p>
          <div class="grid grid-cols-1 gap-1 text-[11px] font-mono">
            <div class="flex gap-2"><span class="text-green-400 w-12">POST</span><span class="text-gray-400">/api/compress/image</span></div>
            <div class="flex gap-2"><span class="text-green-400 w-12">POST</span><span class="text-gray-400">/api/compress/video</span></div>
            <div class="flex gap-2"><span class="text-green-400 w-12">POST</span><span class="text-gray-400">/api/compress/audio</span></div>
            <div class="flex gap-2"><span class="text-blue-400 w-12">GET</span><span class="text-gray-400">/api/jobs/status/{id}</span></div>
            <div class="flex gap-2"><span class="text-red-400 w-12">DEL</span><span class="text-gray-400">/api/jobs/delete/{id}</span></div>
            <div class="flex gap-2"><span class="text-blue-400 w-12">GET</span><span class="text-gray-400">/api/health</span></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Upload + Lookup (side by side on large) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Upload (takes 2 cols) -->
      <section class="lg:col-span-2 bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
        <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Compress Media</h2>
        <div id="drop-zone" class="drop-zone border-2 border-dashed border-gray-700 rounded-xl p-8 text-center cursor-pointer hover:border-gray-600 transition-colors">
          <svg class="w-8 h-8 mx-auto mb-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          <p class="text-gray-400 text-sm mb-1">Drop your file here or <span class="text-brand-400 underline">browse</span></p>
          <p class="text-gray-600 text-[10px]">Images, videos, or audio up to 500MB &middot; Press <kbd class="bg-gray-800 px-1 rounded">U</kbd></p>
          <input id="file-input" type="file" class="hidden" accept="image/*,video/*,audio/*" />
        </div>
        <div id="file-preview" class="hidden mt-3 bg-gray-800 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div id="file-icon" class="w-9 h-9 rounded-lg bg-gray-700 flex items-center justify-center text-base"></div>
              <div>
                <p id="file-name" class="text-sm font-medium"></p>
                <p id="file-meta" class="text-[10px] text-gray-500"></p>
              </div>
            </div>
            <button onclick="clearFile()" class="text-gray-500 hover:text-gray-300 text-xs">Remove</button>
          </div>
        </div>
        <div id="options-panel" class="hidden mt-3 space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-[10px] text-gray-500 mb-1">Output Format</label>
              <select id="output-format" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500"></select>
            </div>
            <div>
              <label class="block text-[10px] text-gray-500 mb-1">Qualities</label>
              <input id="qualities" type="text" placeholder="e.g. 80,60,40" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 placeholder-gray-600" />
            </div>
            <div>
              <label class="block text-[10px] text-gray-500 mb-1" id="thumb-label">Thumbnails</label>
              <input id="thumbnails" type="text" placeholder="e.g. 200,400" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 placeholder-gray-600" />
            </div>
          </div>
          <button onclick="startCompression()" id="compress-btn" class="w-full py-2.5 bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 rounded-lg font-medium text-sm transition-all">Start Compression</button>
        </div>
      </section>

      <!-- Lookup + Activity (stacked in 1 col) -->
      <section class="space-y-6">
        <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
          <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Lookup Job</h2>
          <div class="flex gap-2">
            <input id="lookup-id" type="text" placeholder="Job ID..." class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-xs font-mono focus:outline-none focus:ring-2 focus:ring-brand-500 placeholder-gray-600" />
            <button onclick="lookupJob()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs font-medium transition-colors">Go</button>
          </div>
          <div id="lookup-result" class="hidden mt-3"></div>
        </div>
        <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
          <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Activity Feed</h2>
          <div id="activity-feed" class="space-y-2 max-h-48 overflow-y-auto">
            <p class="text-[11px] text-gray-600 text-center py-4">No activity yet</p>
          </div>
        </div>
      </section>
    </div>

    <!-- Compression size chart (visual) -->
    <section id="chart-section" class="hidden bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
      <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider mb-3">Compression Results</h2>
      <div id="compression-chart" class="space-y-3"></div>
    </section>

    <!-- Jobs List -->
    <section class="bg-gray-900 rounded-xl border border-gray-800 p-5 fade-in">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-4">
          <h2 class="text-[10px] font-medium text-gray-500 uppercase tracking-wider">Jobs</h2>
          <div class="flex border-b border-gray-800 text-xs">
            <button onclick="setJobFilter('all')" data-filter="all" class="pb-1 px-2 border-b-2 tab-active transition-colors">All</button>
            <button onclick="setJobFilter('active')" data-filter="active" class="pb-1 px-2 border-b-2 tab-inactive transition-colors">Active</button>
            <button onclick="setJobFilter('completed')" data-filter="completed" class="pb-1 px-2 border-b-2 tab-inactive transition-colors">Done</button>
            <button onclick="setJobFilter('failed')" data-filter="failed" class="pb-1 px-2 border-b-2 tab-inactive transition-colors">Failed</button>
          </div>
        </div>
        <button onclick="clearJobs()" class="text-[10px] text-gray-600 hover:text-gray-400 transition-colors">Clear All</button>
      </div>
      <div id="jobs-list" class="space-y-2">
        <p id="no-jobs" class="text-xs text-gray-600 text-center py-6">No compression jobs yet. Upload a file to get started.</p>
      </div>
    </section>

  </main>

  <footer class="border-t border-gray-800 mt-8 py-4 text-center text-[10px] text-gray-600">
    Codec &mdash; Media Compressor &middot; Open Source &middot; MIT License &middot; <a href="https://github.com/ErzenXz/media-compressor" class="text-gray-500 hover:text-gray-400">GitHub</a>
  </footer>

<script>
// ====== STATE ======
let selectedFile = null;
const jobs = JSON.parse(localStorage.getItem('mc_jobs') || '[]');
let pollingIntervals = {};
let jobFilter = 'all';
let lastHealthData = null;
let lastLatency = null;

// Persisted stats
const stats = JSON.parse(localStorage.getItem('mc_stats') || '{"total":0,"completed":0,"failed":0,"bytesIn":0,"bytesOut":0,"ratios":[],"latencies":[]}');

// ====== DOM ======
const apiKeyInput = document.getElementById('api-key');
const apiUrlInput = document.getElementById('api-url');
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const filePreview = document.getElementById('file-preview');
const optionsPanel = document.getElementById('options-panel');

// Auto-detect base URL
apiUrlInput.value = window.location.origin;
const savedKey = localStorage.getItem('mc_api_key');
if (savedKey) apiKeyInput.value = savedKey;
apiKeyInput.addEventListener('change', () => localStorage.setItem('mc_api_key', apiKeyInput.value));
const savedUrl = localStorage.getItem('mc_api_url');
if (savedUrl) apiUrlInput.value = savedUrl;
apiUrlInput.addEventListener('change', () => localStorage.setItem('mc_api_url', apiUrlInput.value));

// ====== HELPERS ======
function getBaseUrl() { return apiUrlInput.value.replace(/\/$/, ''); }
function getApiKey() { return apiKeyInput.value.trim(); }
function formatBytes(b) {
  if (!b || b === 0) return '0 B';
  const k = 1024, s = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(b) / Math.log(k));
  return (b / Math.pow(k, i)).toFixed(1) + ' ' + s[i];
}
function getMediaType(file) {
  if (file.type.startsWith('image/')) return 'image';
  if (file.type.startsWith('video/')) return 'video';
  if (file.type.startsWith('audio/')) return 'audio';
  return 'unknown';
}
function getTypeIcon(t) { return {image:'<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',video:'<svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>',audio:'<svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>'}[t] || '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>'; }
function getTypeEmoji(t) { return {image:'ðŸ–¼ï¸',video:'ðŸŽ¬',audio:'ðŸŽµ'}[t]||'ðŸ“„'; }
function getStatusColor(s) { return {queued:'bg-yellow-500/15 text-yellow-400',processing:'bg-blue-500/15 text-blue-400',completed:'bg-green-500/15 text-green-400',failed:'bg-red-500/15 text-red-400'}[s]||'bg-gray-500/15 text-gray-400'; }
function getStatusDot(s) { return {queued:'bg-yellow-400',processing:'bg-blue-400',completed:'bg-green-400',failed:'bg-red-400'}[s]||'bg-gray-400'; }
function saveJobs() { localStorage.setItem('mc_jobs', JSON.stringify(jobs.map(j => ({...j, results: j.results})))); }
function saveStats() { localStorage.setItem('mc_stats', JSON.stringify(stats)); }
function timeAgo(d) { const s=Math.floor((Date.now()-new Date(d))/1000); if(s<60) return s+'s ago'; if(s<3600) return Math.floor(s/60)+'m ago'; if(s<86400) return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago'; }

// ====== TOAST ======
function showToast(message, type='info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  const colors = {success:'bg-green-900/95 border-green-700 text-green-200',error:'bg-red-900/95 border-red-700 text-red-200',info:'bg-gray-800/95 border-gray-600 text-gray-200'};
  toast.className = `${colors[type]||colors.info} border rounded-lg px-4 py-2.5 text-xs shadow-xl fade-in backdrop-blur-sm pointer-events-auto`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity .3s'; setTimeout(()=>toast.remove(),300); }, 4000);
}

// ====== ACTIVITY FEED ======
const activityLog = JSON.parse(localStorage.getItem('mc_activity') || '[]');
function logActivity(msg, type='info') {
  activityLog.unshift({msg, type, time: new Date().toISOString()});
  if (activityLog.length > 50) activityLog.length = 50;
  localStorage.setItem('mc_activity', JSON.stringify(activityLog));
  renderActivity();
}
function renderActivity() {
  const feed = document.getElementById('activity-feed');
  if (activityLog.length === 0) { feed.innerHTML = '<p class="text-[11px] text-gray-600 text-center py-4">No activity yet</p>'; return; }
  feed.innerHTML = activityLog.slice(0, 20).map(a => {
    const c = {info:'text-gray-400',success:'text-green-400',error:'text-red-400',warn:'text-yellow-400'}[a.type]||'text-gray-400';
    return `<div class="flex items-start gap-2 text-[11px]"><span class="text-gray-600 shrink-0 w-12">${timeAgo(a.time)}</span><span class="${c}">${a.msg}</span></div>`;
  }).join('');
}

// ====== STATS ======
function updateStatsUI() {
  document.getElementById('stat-total').textContent = stats.total;
  document.getElementById('stat-completed').textContent = stats.completed;
  document.getElementById('stat-failed').textContent = stats.failed;
  document.getElementById('stat-bytes').textContent = formatBytes(stats.bytesIn);
  if (stats.ratios.length > 0) {
    const avg = stats.ratios.reduce((a,b)=>a+b,0) / stats.ratios.length;
    document.getElementById('stat-ratio').textContent = avg.toFixed(1) + '%';
  }
  if (lastLatency !== null) {
    document.getElementById('stat-latency').textContent = lastLatency + 'ms';
  }
}

// ====== HEALTH CHECK ======
async function checkHealth() {
  const indicator = document.getElementById('health-indicator');
  const section = document.getElementById('status-section');
  const btn = document.getElementById('test-btn');
  btn.textContent = 'Testing...';
  const t0 = performance.now();
  try {
    const res = await fetch(getBaseUrl() + '/api/health');
    const latency = Math.round(performance.now() - t0);
    lastLatency = latency;
    stats.latencies.push(latency);
    if (stats.latencies.length > 20) stats.latencies.shift();
    saveStats();
    const data = await res.json();
    lastHealthData = data;
    const ok = data.status === 'healthy';
    indicator.innerHTML = `<span class="w-2 h-2 rounded-full ${ok?'bg-green-400 status-pulse healthy':'bg-red-400'}"></span><span>${ok?'Healthy':'Unhealthy'}</span>`;
    const badge = document.getElementById('latency-badge');
    badge.textContent = latency + 'ms';
    badge.classList.remove('hidden');
    section.classList.remove('hidden');
    document.getElementById('status-grid').innerHTML = `
      ${statusCard('Queue',data.services?.queue)}
      ${statusCard('Storage',data.services?.storage)}
      ${statusCard('Rate Limit',data.services?.rateLimit)}
      ${statusCard('API Keys',data.config?.apiKeysConfigured)}
    `;
    document.getElementById('health-detail').textContent = `Max file: ${data.config?.maxFileSize} | Timeout: ${data.config?.timeout} | Latency: ${latency}ms`;
    logActivity(`Health check OK (${latency}ms)`, 'success');
    updateStatsUI();
  } catch (e) {
    const latency = Math.round(performance.now() - t0);
    indicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span><span>Offline</span>';
    section.classList.add('hidden');
    logActivity(`Health check failed (${latency}ms): ${e.message}`, 'error');
    showToast('Connection failed: ' + e.message, 'error');
  } finally {
    btn.textContent = 'Test Connection';
  }
}

function statusCard(name, ok) {
  return `<div class="bg-gray-800/50 rounded-lg p-3 flex items-center gap-2.5">
    <span class="w-2 h-2 rounded-full ${ok?'bg-green-400':'bg-red-400'}"></span>
    <div>
      <p class="text-[10px] text-gray-500">${name}</p>
      <p class="text-xs font-medium ${ok?'text-green-400':'text-red-400'}">${ok?'Connected':'Off'}</p>
    </div>
  </div>`;
}

// ====== DRAG & DROP ======
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', (e) => { if(e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  selectedFile = file;
  const type = getMediaType(file);
  document.getElementById('file-icon').innerHTML = getTypeIcon(type);
  document.getElementById('file-name').textContent = file.name;
  document.getElementById('file-meta').textContent = `${formatBytes(file.size)} Â· ${file.type}`;
  filePreview.classList.remove('hidden');
  optionsPanel.classList.remove('hidden');
  const fmt = document.getElementById('output-format');
  const qIn = document.getElementById('qualities');
  const tIn = document.getElementById('thumbnails');
  const tLbl = document.getElementById('thumb-label');
  if (type==='image') { fmt.innerHTML='<option value="webp">WebP</option><option value="jpeg">JPEG</option><option value="png">PNG</option><option value="avif">AVIF</option>'; qIn.placeholder='e.g. 80,60,40'; tIn.placeholder='e.g. 200,400'; tLbl.textContent='Thumbnail Sizes (px)'; tIn.parentElement.classList.remove('hidden'); }
  else if (type==='video') { fmt.innerHTML='<option value="mp4">MP4</option><option value="webm">WebM</option><option value="mov">MOV</option>'; qIn.placeholder='e.g. 1080,720,480'; tIn.placeholder='e.g. 3'; tLbl.textContent='Thumbnails Count'; tIn.parentElement.classList.remove('hidden'); }
  else if (type==='audio') { fmt.innerHTML='<option value="mp3">MP3</option><option value="aac">AAC</option><option value="opus">Opus</option><option value="wav">WAV</option>'; qIn.placeholder='e.g. 320,192,128'; tIn.parentElement.classList.add('hidden'); }
  logActivity(`Selected: ${file.name} (${formatBytes(file.size)})`, 'info');
}

function clearFile() { selectedFile=null; fileInput.value=''; filePreview.classList.add('hidden'); optionsPanel.classList.add('hidden'); }

// ====== COMPRESSION ======
async function startCompression() {
  if (!selectedFile) return;
  if (!getApiKey()) { showToast('Enter your API key first','error'); return; }
  const type = getMediaType(selectedFile);
  const format = document.getElementById('output-format').value;
  const qualitiesRaw = document.getElementById('qualities').value.trim();
  const thumbsRaw = document.getElementById('thumbnails').value.trim();
  const btn = document.getElementById('compress-btn');
  btn.innerHTML = '<svg class="w-4 h-4 inline spinner mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Uploading...';
  btn.disabled = true;
  try {
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('format', format);
    if (qualitiesRaw) { const vals=qualitiesRaw.split(',').map(v=>parseInt(v.trim())).filter(v=>!isNaN(v)); formData.append(type==='audio'?'bitrates':'qualities', JSON.stringify(vals)); }
    if (thumbsRaw) { if(type==='image'){const s=thumbsRaw.split(',').map(v=>parseInt(v.trim())).filter(v=>!isNaN(v));formData.append('thumbnails',JSON.stringify(s));}else if(type==='video'){formData.append('thumbnails',thumbsRaw.trim());} }
    const res = await fetch(`${getBaseUrl()}/api/compress/${type}`, { method:'POST', headers:{'X-API-Key':getApiKey()}, body:formData });
    const data = await res.json();
    if (data.success && data.jobId) {
      addJob({id:data.jobId, type, fileName:selectedFile.name, fileSize:selectedFile.size, status:'queued', progress:0, createdAt:new Date().toISOString(), estimatedTime:data.estimatedTime});
      stats.total++; stats.bytesIn += selectedFile.size; saveStats(); updateStatsUI();
      logActivity(`Queued ${type}: ${selectedFile.name}`, 'success');
      showToast('Job queued: ' + data.jobId, 'success');
      clearFile();
    } else {
      showToast(data.error || 'Unknown error', 'error');
      logActivity(`Upload failed: ${data.error}`, 'error');
    }
  } catch (e) {
    showToast('Request failed: ' + e.message, 'error');
    logActivity(`Upload error: ${e.message}`, 'error');
  } finally { btn.innerHTML = 'Start Compression'; btn.disabled = false; }
}

// ====== JOB MANAGEMENT ======
function addJob(job) { jobs.unshift(job); saveJobs(); renderJobs(); startPolling(job.id); }

function startPolling(jobId) {
  if (pollingIntervals[jobId]) return;
  pollingIntervals[jobId] = setInterval(async () => {
    try {
      const res = await fetch(`${getBaseUrl()}/api/jobs/status/${jobId}`, { headers:{'X-API-Key':getApiKey()} });
      const data = await res.json();
      if (!data.success) return;
      const job = jobs.find(j=>j.id===jobId);
      if (!job) return;
      const prevStatus = job.status;
      job.status = data.status; job.progress = data.progress ?? 0; job.error = data.error; job.results = data.results; job.completedAt = data.completedAt;
      saveJobs(); renderJobs();
      if (data.status === 'completed' && prevStatus !== 'completed') {
        stats.completed++;
        if (data.results?.compressionRatio) { const r = parseFloat(data.results.compressionRatio); if(!isNaN(r)) stats.ratios.push(r); }
        saveStats(); updateStatsUI(); updateChart();
        logActivity(`Completed: ${job.fileName} (${data.results?.compressionRatio || 'N/A'})`, 'success');
        showToast(`Completed: ${job.fileName}`, 'success');
      }
      if (data.status === 'failed' && prevStatus !== 'failed') {
        stats.failed++; saveStats(); updateStatsUI();
        logActivity(`Failed: ${job.fileName} - ${data.error}`, 'error');
        showToast(`Failed: ${job.fileName}`, 'error');
      }
      if (data.status === 'completed' || data.status === 'failed') { clearInterval(pollingIntervals[jobId]); delete pollingIntervals[jobId]; }
    } catch (e) { /* retry */ }
  }, 3000);
}

function clearJobs() {
  Object.keys(pollingIntervals).forEach(id => clearInterval(pollingIntervals[id]));
  pollingIntervals = {}; jobs.length = 0; saveJobs(); renderJobs(); updateChart();
  logActivity('Cleared all jobs', 'warn');
}

function setJobFilter(f) {
  jobFilter = f;
  document.querySelectorAll('[data-filter]').forEach(btn => {
    btn.classList.toggle('tab-active', btn.dataset.filter === f);
    btn.classList.toggle('tab-inactive', btn.dataset.filter !== f);
  });
  renderJobs();
}

function renderJobs() {
  const container = document.getElementById('jobs-list');
  const noJobs = document.getElementById('no-jobs');
  const filtered = jobs.filter(j => {
    if (jobFilter === 'all') return true;
    if (jobFilter === 'active') return j.status === 'queued' || j.status === 'processing';
    return j.status === jobFilter;
  });
  container.querySelectorAll('.job-card').forEach(el => el.remove());
  if (filtered.length === 0) { noJobs.classList.remove('hidden'); noJobs.textContent = jobFilter==='all'?'No compression jobs yet. Upload a file to get started.':`No ${jobFilter} jobs.`; return; }
  noJobs.classList.add('hidden');
  filtered.forEach(job => {
    const card = document.createElement('div');
    card.className = 'job-card bg-gray-800/50 rounded-lg p-4 fade-in';
    const elapsed = job.completedAt ? ((new Date(job.completedAt)-new Date(job.createdAt))/1000).toFixed(1)+'s' : job.estimatedTime || '...';
    let resultsHtml = '';
    if (job.status === 'completed' && job.results) {
      const r = job.results;
      resultsHtml = `<div class="mt-3 pt-3 border-t border-gray-700/50 space-y-1.5">
        <div class="flex justify-between text-[11px]"><span class="text-gray-500">Compression</span><span class="text-green-400 font-semibold">${r.compressionRatio||'N/A'}</span></div>
        ${r.original ? `<div class="flex justify-between text-[11px]"><span class="text-gray-500">Original</span><a href="${r.original.url}" target="_blank" class="text-brand-400 hover:underline">${formatBytes(r.original.size)}</a></div>` : ''}
        ${(r.compressed||[]).map(c => `<div class="flex justify-between text-[11px]"><span class="text-gray-500">${c.quality||c.bitrate||''}</span><a href="${c.url}" target="_blank" class="text-brand-400 hover:underline">${formatBytes(c.size)}</a></div>`).join('')}
        ${(r.thumbnails||[]).length ? `<div class="flex justify-between text-[11px]"><span class="text-gray-500">Thumbnails</span><span class="text-gray-400">${r.thumbnails.length} generated</span></div>` : ''}
      </div>`;
    }
    let errorHtml = job.status==='failed'&&job.error ? `<div class="mt-2 text-[11px] text-red-400 bg-red-500/10 rounded px-3 py-2">${job.error}</div>` : '';
    card.innerHTML = `
      <div class="flex items-center justify-between mb-1.5">
        <div class="flex items-center gap-2.5">
          <div class="w-8 h-8 rounded-lg bg-gray-700/50 flex items-center justify-center">${getTypeIcon(job.type)}</div>
          <div>
            <p class="text-sm font-medium leading-tight">${job.fileName}</p>
            <p class="text-[10px] text-gray-500">${formatBytes(job.fileSize)} &middot; ${elapsed}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          ${(job.status==='completed'||job.status==='failed') ? `<button onclick="deleteJob('${job.id}')" class="text-gray-600 hover:text-red-400 transition-colors" title="Delete"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>` : ''}
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${getStatusColor(job.status)}">
            <span class="w-1.5 h-1.5 rounded-full ${getStatusDot(job.status)}"></span>${job.status}
          </span>
        </div>
      </div>
      ${(job.status==='processing'||job.status==='queued') ? `<div class="w-full bg-gray-700 rounded-full h-1 mt-2"><div class="progress-bar bg-brand-500 h-1 rounded-full" style="width:${job.progress}%"></div></div><p class="text-[10px] text-gray-500 mt-0.5">${job.progress}%</p>` : ''}
      ${resultsHtml}${errorHtml}
      <p class="text-[10px] text-gray-600 mt-1.5 font-mono select-all cursor-pointer" title="Click to copy" onclick="navigator.clipboard.writeText('${job.id}');showToast('Copied job ID','info')">${job.id}</p>
    `;
    container.appendChild(card);
  });
}

// ====== COMPRESSION CHART ======
function updateChart() {
  const section = document.getElementById('chart-section');
  const container = document.getElementById('compression-chart');
  const completed = jobs.filter(j => j.status==='completed' && j.results);
  if (completed.length === 0) { section.classList.add('hidden'); return; }
  section.classList.remove('hidden');
  container.innerHTML = completed.slice(0, 8).map(job => {
    const r = job.results;
    const origSize = r.original?.size || job.fileSize;
    const compSize = r.compressed?.[0]?.size || origSize;
    const pctOrig = 100;
    const pctComp = Math.max(2, Math.round((compSize / origSize) * 100));
    return `<div class="space-y-1">
      <div class="flex items-center justify-between text-[11px]">
        <span class="text-gray-300 truncate max-w-[200px]">${job.fileName}</span>
        <span class="text-green-400 font-medium">${r.compressionRatio||'--'}</span>
      </div>
      <div class="flex gap-1 h-4">
        <div class="bar-segment bg-gray-600 rounded-sm" style="width:${pctOrig}%" title="Original: ${formatBytes(origSize)}"></div>
      </div>
      <div class="flex gap-1 h-4">
        <div class="bar-segment bg-brand-500 rounded-sm" style="width:${pctComp}%" title="Compressed: ${formatBytes(compSize)}"></div>
      </div>
      <div class="flex justify-between text-[10px] text-gray-500">
        <span>Original: ${formatBytes(origSize)}</span>
        <span>Compressed: ${formatBytes(compSize)}</span>
      </div>
    </div>`;
  }).join('<div class="border-t border-gray-800 my-1"></div>');
}

// ====== JOB LOOKUP ======
async function lookupJob() {
  const id = document.getElementById('lookup-id').value.trim();
  const rd = document.getElementById('lookup-result');
  if (!id) { showToast('Enter a job ID','error'); return; }
  if (!getApiKey()) { showToast('Enter your API key','error'); return; }
  rd.classList.remove('hidden');
  rd.innerHTML = '<p class="text-xs text-gray-500">Looking up...</p>';
  try {
    const res = await fetch(`${getBaseUrl()}/api/jobs/status/${id}`, { headers:{'X-API-Key':getApiKey()} });
    const data = await res.json();
    if (!data.success) { rd.innerHTML = `<div class="bg-red-500/10 border border-red-800 rounded-lg p-3 text-xs text-red-400">${data.error||'Job not found'}</div>`; return; }
    const s = data;
    rd.innerHTML = `<div class="bg-gray-800/50 rounded-lg p-3 space-y-2">
      <div class="flex justify-between items-center"><span class="text-xs font-medium font-mono">${s.jobId}</span><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${getStatusColor(s.status)}"><span class="w-1.5 h-1.5 rounded-full ${getStatusDot(s.status)}"></span>${s.status}</span></div>
      <div class="grid grid-cols-2 gap-1 text-[11px] text-gray-400"><div>Type: <span class="text-gray-200">${s.type||'N/A'}</span></div><div>Progress: <span class="text-gray-200">${s.progress??0}%</span></div></div>
      ${s.error?`<div class="text-[11px] text-red-400 bg-red-500/10 rounded px-2 py-1">${s.error}</div>`:''}
      ${s.results?`<div class="text-[11px] text-green-400">Ratio: ${s.results.compressionRatio||'N/A'}</div>`:''}
      <div class="flex gap-2 pt-1">${(s.status==='completed'||s.status==='failed')?`<button onclick="deleteJob('${s.jobId}')" class="px-2 py-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 rounded text-[10px] transition-colors">Delete</button>`:`<button onclick="document.getElementById('lookup-id').value='${s.jobId}';lookupJob()" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-[10px] transition-colors">Refresh</button>`}</div>
    </div>`;
    logActivity(`Looked up job ${id.slice(0,20)}...`, 'info');
  } catch (e) { rd.innerHTML = `<div class="bg-red-500/10 border border-red-800 rounded-lg p-3 text-xs text-red-400">${e.message}</div>`; }
}

// ====== DELETE JOB ======
async function deleteJob(jobId) {
  if (!confirm('Delete this job and all files?')) return;
  try {
    const res = await fetch(`${getBaseUrl()}/api/jobs/delete/${jobId}`, { method:'DELETE', headers:{'X-API-Key':getApiKey()} });
    const data = await res.json();
    if (data.success) {
      showToast('Job deleted','success');
      if(pollingIntervals[jobId]){clearInterval(pollingIntervals[jobId]);delete pollingIntervals[jobId];}
      const idx = jobs.findIndex(j=>j.id===jobId);
      if(idx!==-1) jobs.splice(idx,1);
      saveJobs(); renderJobs(); updateChart();
      logActivity(`Deleted job ${jobId.slice(0,20)}...`, 'warn');
    } else { showToast(data.error||'Failed','error'); }
  } catch (e) { showToast('Delete failed: '+e.message,'error'); }
}

// ====== KEYBOARD SHORTCUTS ======
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (e.key === 'u' || e.key === 'U') { e.preventDefault(); fileInput.click(); }
  if (e.key === 't' || e.key === 'T') { e.preventDefault(); checkHealth(); }
  if (e.key === 'l' || e.key === 'L') { e.preventDefault(); document.getElementById('lookup-id').focus(); }
  if (e.key === 'X' && e.shiftKey) { e.preventDefault(); clearJobs(); }
  if (e.key === 'Escape') { document.getElementById('shortcuts-modal').classList.add('hidden'); }
  if (e.key === '?') { document.getElementById('shortcuts-modal').classList.toggle('hidden'); }
});

// ====== INIT ======
renderJobs();
renderActivity();
updateStatsUI();
updateChart();
// Resume polling for active jobs
jobs.filter(j => j.status === 'queued' || j.status === 'processing').forEach(j => startPolling(j.id));
// Auto health check
setTimeout(checkHealth, 300);
</script>

</body>
</html>
